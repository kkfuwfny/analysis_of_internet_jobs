#-*- coding: utf-8 -*-
#encoding = utf-8
#这个版本完成的任务：
#实现数据库的链接和导入数据((公司名称，岗位，时间，要求（未处理）))
#

import string 
import urllib
import urllib2  
import re
import MySQLdb
#form  con_mysql import con_mysql
def main():
    url='http://search.51job.com/jobsearch/search_result.php?fromJs=1&jobarea=000000%2C00&district=000000&funtype=0100%2C2400%2C2700%2C2600%2C2500&industrytype=01%2C37%2C38%2C32%2C40&issuedate=9&providesalary=99&keywordtype=2&curr_page=1&lang=c&stype=2&postchannel=0000&workyear=99&cotype=99&degreefrom=99&jobterm=0&companysize=99&lonlat=0%2C0&radius=-1&ord_field=0&list_type=0&fromType=14'
#user_agent = 'Mozilla/4.0 (compatible;MSIE 5.5; WindowsNT)'
  #unicondePage = page.decode("utf-8")
#headers={'User_Agent':user_agent}
    try:
        testcompany=''
        testposition=''
        testtime=''
        testeducation=''
        testtext=''
        page = urllib2.urlopen(url).read().decode('gbk')
        #unicodepage=page.decode('gbk')
        #print page
    
    #打开文件
        f=file('data.txt','w+')
        jobhref= re.findall('<td class="td1"><a adid="".*?href="(.*?)"',page)
        print u'jobhreflength=',len(jobhref)
        for href in jobhref:
            urlinfo = href
            f.writelines(urlinfo+'\n')
       # reqinfo=urllib2.Request(urlinfo)
            pageinfo = urllib2.urlopen(urlinfo).read().decode("gbk")
       # unicodepageinfo = pageinfo.decode('utf-8')
    #print unicodepageinfo
            company =re.findall('<a target="_blank" style=".*?" href=".*?">(.*?)</a>',pageinfo) 
            for com in company:
                #f.writelines(com.encode('utf-8')+'\n')
                testcompany=com
            #print 'testcom',testcompany
            title = re.findall('<td class="sr_bt" colspan=".*?" >(.*?)</td>',pageinfo)
      #  print 'title=',title
            for tit in title:
                testposition=tit.encode('utf-8')
               # f.writelines(titstr+'\n')
        #release_time=re.findall('<td class="txt_2 ">(.*?)</td>',pageinfo)   
       
        #print 'rel_time=',release_time[0]
        #f.writelines(release_time[0].encode('utf-8')+'\n')
        
        #xueli
        
       # education = re.findall('<td class="txt_1" width="12%">学&nbsp;&nbsp;&nbsp;&nbsp;历：</td><td class="txt_2 ">(.*?)</td>',pageinfo)
            education = re.findall('<td class="txt_1" width="12%">(.*?)</td><td class="txt_2 ">(.*?)</td>',pageinfo)
        #education =education.replace('&nbsp;','')
            for edu in education:
                edu_0= edu[0].replace('&nbsp;','').encode('utf-8')
                edu_1= edu[1].encode('utf-8')
                if cmp('发布日期：',edu_0)==0:
                    testtime= edu[1].encode('utf-8')
                if cmp('学历：',edu_0)==0:
                     testeducation= edu[1].encode('utf-8')
                    #print  edu[1].encode('utf-8')
                     
               # f.writelines(edu[0].replace('&nbsp;','').encode('utf-8')+edu[1].encode('utf-8') +'\n')
        #the job request[
            job_request = re.findall('<div style="padding-bottom:30px;">(.*?)</div>',pageinfo)
       
            for job_req in job_request:
                testtext=job_req.replace('<br>','').replace('<p>','').replace('</p>','').replace('<BR>','').replace('<\DIV>','').replace('<DIV>','').replace('<div>','').encode('utf-8')
                #f.writelines(job_req.replace('<br>','').replace('<div>','').encode('utf-8')+'\n\n\n')
                print testtext + '\n\n'

            save_data(testcompany,testposition,testtime,testeducation,testtext)

        f.close()
    except urllib2.HTTPError,e:
        print 'Error code:',e.code
    except urllib2.URLError,e:
        print 'Reason:',e.reason

    else:
        print 'No exception was raised.'


#存入数据库 test
def save_data(company,position,release_date,education,description):
#def save_data():
    try:
        conn = MySQLdb.connect (user='root',passwd='3288',host='127.0.0.1', port=3306,charset='utf8')
        cur = conn.cursor()
        conn.select_db('51job')
        #sqlinsert = "insert into job_description (company,position,release_date,education,description) value(%s, %s,%s,%s,%s)"
        #job=(company,position,release_date,education,description)
        #cur.execute(sqlinsert,job)
        sql ="select * from job_description where company='小米公司'"
        cur.execute(sql)
        re_found = cur.fetchall()
        if re_found is not None:
            print "query starting"
            for i in re_found:
                print i[1]
            print "query ending!"
        #conn.commit()
        cur.close()
        conn.close()
    except MySQLdb.Error,e:
        print "MySQLdb Error %d: %s" % (e.args[0], e.args[1])
print 'start test save datas'
#save_data()
main()
print 'end'



